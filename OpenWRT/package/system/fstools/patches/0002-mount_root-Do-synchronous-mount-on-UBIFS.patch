From 134fd06185e6759600c3e90aeabca7c1e3181a35 Mon Sep 17 00:00:00 2001

Date: Thu, 12 Nov 2015 20:05:31 +0800
Subject: [PATCH 2/2] mount_root: Do synchronous mount on UBIFS

---
 libfstools/overlay.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

Index: fstools-2018-04-16-e2436836/libfstools/overlay.c
===================================================================
--- fstools-2018-04-16-e2436836.orig/libfstools/overlay.c
+++ fstools-2018-04-16-e2436836/libfstools/overlay.c
@@ -335,13 +335,17 @@ jffs2_switch(struct volume *v)
 static int overlay_mount_fs(struct volume *v)
 {
 	char *fstype = overlay_fs_name(volume_identify(v));
+	uint32_t flag = MS_NOATIME;
 
 	if (mkdir("/tmp/overlay", 0755)) {
 		ULOG_ERR("failed to mkdir /tmp/overlay: %m\n");
 		return -1;
 	}
 
-	if (mount(v->blk, "/tmp/overlay", fstype, MS_NOATIME, NULL)) {
+	if (!strcmp(fstype, "ubifs"))
+		flag |= MS_SYNCHRONOUS;
+
+	if (mount(v->blk, "/tmp/overlay", fstype, flag, NULL)) {
 		ULOG_ERR("failed to mount -t %s %s /tmp/overlay: %m\n",
 		         fstype, v->blk);
 		return -1;
